local HttpService = game:GetService("HttpService")
local Player = game:GetService("Players").LocalPlayer
local VirtualUser = game:GetService("VirtualUser")

-- Function to save the state locally (avoiding issues with sethiddenproperty)
local function saveState(enabled)
    local playerData = Player:FindFirstChild("PlayerData")
    if not playerData then
        playerData = Instance.new("Folder")
        playerData.Name = "PlayerData"
        playerData.Parent = Player
    end

    local stateValue = Instance.new("StringValue")
    stateValue.Name = "BossFarmEnabled"
    stateValue.Value = enabled and "true" or "false"
    stateValue.Parent = playerData
end

-- Function to load the saved state
local function loadState()
    local playerData = Player:FindFirstChild("PlayerData")
    if playerData then
        local stateValue = playerData:FindFirstChild("BossFarmEnabled")
        if stateValue and stateValue.Value == "true" then
            return true
        end
    end
    return false
end

-- UI Setup (keeping the original look and colors)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui
local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 250, 0, 100)
Frame.Position = UDim2.new(0.5, -125, 0.1, 0)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 90) -- Deep Blue Background
Frame.Parent = ScreenGui
local UICorner = Instance.new("UICorner", Frame) -- Rounded corners

-- Toggle Button
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 200, 0, 50)
ToggleButton.Position = UDim2.new(0.5, -100, 0.25, 0)
ToggleButton.BackgroundColor3 = loadState() and Color3.fromRGB(180, 0, 180) or Color3.fromRGB(90, 0, 180) -- Purple
ToggleButton.Text = loadState() and "Stop Autofarm" or "Start Autofarm"
ToggleButton.TextSize = 20
ToggleButton.Parent = Frame
local ButtonCorner = Instance.new("UICorner", ToggleButton)

-- Anti-AFK Loop
local function antiAFK()
    while true do
        if loadState() then
            game:GetService("Players").LocalPlayer.Idled:connect(function()
                VirtualUser:CaptureController()
                VirtualUser:ClickButton1(Vector2.new()) -- Simulate mouse activity to prevent AFK kick
            end)
        end
        task.wait(5) -- Delay between AFK checks
    end
end

-- Autofarm Function
local function startAutoFarm()
    while loadState() do
        local boss = workspace:FindFirstChild("BadTimeTrioBoss")
        if boss and boss:FindFirstChild("Char") and boss.Char:FindFirstChild("Head") then
            local head = boss.Char.Head
            local originalCFrame = Player.Character.HumanoidRootPart.CFrame -- Save position
            Player.Character.HumanoidRootPart.CFrame = head.CFrame -- Teleport to boss
            task.wait(0.5)
            head:Destroy() -- Kill boss
            task.wait(1)
            Player.Character.HumanoidRootPart.CFrame = originalCFrame -- Return to original position
        end
        task.wait(1)
    end
end

-- Toggle Autofarm on button click
ToggleButton.MouseButton1Click:Connect(function()
    local autoFarmEnabled = not loadState()
    ToggleButton.Text = autoFarmEnabled and "Stop Autofarm" or "Start Autofarm"
    ToggleButton.BackgroundColor3 = autoFarmEnabled and Color3.fromRGB(180, 0, 180) or Color3.fromRGB(90, 0, 180) -- Purple colors
    saveState(autoFarmEnabled)

    if autoFarmEnabled then
        startAutoFarm()
    end
end)

-- Start autofarm and anti-AFK if enabled previously
if loadState() then
    startAutoFarm()
    antiAFK()
end
